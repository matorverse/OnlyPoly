<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>ONLYPOLY - Richup Edition</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div id="app">

    <!-- Game Board Area -->
    <div class="game-layout">
      <div class="board-container">
        <!-- Main Board -->
        <div id="board" class="monopoly-board">
          <!-- Tiles generated by JS -->
          <div class="board-center">
            <div class="board-brand">ONLYPOLY</div>
          </div>
        </div>

        <!-- Dice Container (Moved Out to prevent overwrite) -->
        <div id="diceOverlay" class="dice-center-area">
          <div class="richup-dice-container">
            <div id="dice1" class="richup-dice"></div>
            <div id="dice2" class="richup-dice"></div>
          </div>
        </div>
      </div>

      <!-- Sidebar Controls -->
      <aside class="sidebar" id="sidebar">
        <div class="logo-area">ONLYPOLY</div>

        <!-- Players List (Lobby & Game) -->
        <div id="playersList" class="player-list">
          <!-- Player Cards generated by JS -->
        </div>

        <!-- Lobby Controls -->
        <div id="lobbyControls" class="control-panel" style="display:none;">
          <div id="lobbyStatus" style="text-align: center; color: #888; margin-bottom: 10px;">Waiting for players...
          </div>
          <button id="readyToggle" class="btn-richup secondary">Ready</button>
          <button id="startGameBtn" class="btn-richup" style="margin-top: 10px;" disabled>Start Game</button>
          <!-- Game.js populates this pill container -->
          <div id="lobbyPlayers" class="lobby-pills-container"></div>
        </div>

        <!-- Game Controls -->
        <div id="gameControls" class="control-panel" style="display:none;">
          <div class="hud-info"
            style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9em; color: #ccc;">
            <span id="turnLabel">Waiting...</span>
            <span id="moneyDisplay">$0</span>
          </div>

          <button id="rollBtn" class="btn-richup">Roll Dice</button>

          <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button id="buyBtn" class="btn-richup secondary" style="flex: 1;">Buy</button>
            <button id="tradeBtn" class="btn-richup secondary" style="flex: 1;">Trade</button>
          </div>
          <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button id="auctionBtn" class="btn-richup secondary" style="flex: 1;">Auction</button>
            <button id="payJailBtn" class="btn-richup secondary" style="flex: 1;">Pay Jail</button>
          </div>
          <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button id="propertiesBtn" class="btn-richup secondary" style="flex: 1;">Properties</button>
            <button id="playersBtn" class="btn-richup secondary" style="flex: 1;">Info</button>
          </div>
          <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button id="bankruptBtn" class="btn-richup secondary"
              style="flex: 1; background: rgba(231, 76, 60, 0.2); border: 1px solid #e74c3c;">Bankrupt</button>
          </div>

          <button id="endTurnBtn" class="btn-richup secondary" style="margin-top: 10px;" disabled>End Turn</button>
        </div>
      </aside>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal-overlay visible">
      <div class="modal-content">
        <h2 class="font-richup" style="font-size: 2rem; margin-bottom: 20px;">Join Game</h2>
        <input id="nameInput" placeholder="Enter Nickname"
          style="width: 100%; padding: 12px; margin-bottom: 20px; border-radius: 6px; border: 1px solid #444; background: #222; color: white; font-size: 1.1em;">

        <div style="margin-bottom: 20px;">
          <label style="color: #aaa; display:block; margin-bottom:10px;">Choose Color</label>
          <div id="loginColorGrid" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
            <!-- Populated by JS -->
          </div>
          <input type="hidden" id="selectedColorInput" value="#00d2ff">
        </div>

        <button id="joinBtn" class="btn-richup">Enter Lobby</button>
      </div>
    </div>

    <!-- Auction Modal (Restored) -->
    <div id="auctionModal" class="modal-overlay"> <!-- .visible to show -->
      <div class="modal-content">
        <h2 class="font-richup">Auction</h2>
        <div id="auctionInfo" class="auction-info" style="margin: 20px 0;"></div>
        <div class="auction-bid-row" style="display: flex; gap: 10px; justify-content: center;">
          <button class="btn-richup secondary bid" data-step="10">+10</button>
          <button class="btn-richup secondary bid" data-step="50">+50</button>
          <button class="btn-richup secondary bid" data-step="100">+100</button>
        </div>
        <div id="auctionTimer" class="auction-timer" style="margin-top: 15px; color: var(--accent-gold);"></div>
      </div>
    </div>

    <!-- Trade Modal (Restored) -->
    <div id="tradeModal" class="modal-overlay">
      <div class="modal-content" style="width: 600px;">
        <h2 class="font-richup">Trade</h2>
        <div id="tradeContent" class="trade-content"></div>
        <button onclick="document.getElementById('tradeModal').classList.remove('visible')" class="btn-richup secondary"
          style="margin-top: 20px;">Close</button>
      </div>
    </div>

    <!-- Properties Modal -->
    <div id="propertiesModal" class="modal-overlay">
      <div class="modal-content" style="width: 600px; max-width: 90%;">
        <h2 class="font-richup">My Properties</h2>
        <div id="propertiesContent" class="properties-content"></div>
        <button onclick="document.getElementById('propertiesModal').classList.remove('visible')"
          class="btn-richup secondary" style="margin-top: 20px;">Close</button>
      </div>
    </div>

    <!-- Players Modal (NEW) -->
    <div id="playersModal" class="modal-overlay">
      <div class="modal-content" style="width: 500px; max-width: 90%;">
        <h2 class="font-richup">Players</h2>
        <div id="playersContent" class="players-content"></div>
        <button onclick="document.getElementById('playersModal').classList.remove('visible')"
          class="btn-richup secondary" style="margin-top: 20px;">Close</button>
      </div>
    </div>

    <!-- Bankruptcy Confirmation Modal -->
    <div id="bankruptModal" class="modal-overlay">
      <div class="modal-content" style="width: 500px; max-width: 90%;">
        <h2 class="font-richup" style="color: #e74c3c;">⚠️ Declare Bankruptcy</h2>
        <div style="padding: 20px 0; line-height: 1.6;">
          <p style="margin-bottom: 15px; font-size: 1.1em;">Are you sure you want to declare bankruptcy?</p>
          <p style="color: #888; margin-bottom: 10px;">This action cannot be undone. You will:</p>
          <ul style="text-align: left; color: #aaa; margin: 10px 0; padding-left: 30px;">
            <li>Lose all your money</li>
            <li>Lose all your properties</li>
            <li>Be removed from the game</li>
          </ul>
        </div>
        <div style="display: flex; gap: 12px; justify-content: center;">
          <button id="confirmBankruptBtn" class="btn-richup"
            style="background: linear-gradient(to top left, #e74c3c, #c0392b); flex: 1;">Yes, Bankrupt Me</button>
          <button onclick="document.getElementById('bankruptModal').classList.remove('visible')"
            class="btn-richup secondary" style="flex: 1;">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Dummy elements to satisfy game.js references if not used but required -->
    <div id="lobbyPanel" style="display:none;"></div>
    <div id="playersInfoRow" style="display:none;"></div>
    <div id="gamePanel" style="display:none;"></div>
    <div id="positionDisplay" style="display:none;"></div>
    <div id="colorSelection" style="display:none;"></div>
    <div id="colorGrid" style="display:none;"></div>
    <!-- Menu elements (Legacy) -->
    <div id="menuToggle" style="display:none;"></div>
    <div id="secondaryMenu" style="display:none;"></div>
    <div id="closeSecondaryMenu" style="display:none;"></div>
    <div id="propertiesBtn" style="display:none;"></div>
    <div id="playersBtn" style="display:none;"></div>
    <div id="propertiesCount" style="display:none;"></div>
    <div id="propertiesPanel" style="display:none;"></div>
    <div id="closeProperties" style="display:none;"></div>
    <div id="propertiesList" style="display:none;"></div>

  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="flags.js"></script>
  <script src="ui.js"></script>
  <script src="dice.js"></script>
  <script src="game.js"></script>

  <script>
    // Inline Bridge Script to link game.js state to our new UI
    // Since game.js toggles #lobbyPanel and #gamePanel, we observe these and toggle our sidebar controls
    const lobbyPanel = document.getElementById('lobbyPanel');
    const gamePanel = document.getElementById('gamePanel');
    const lobbyControls = document.getElementById('lobbyControls');
    const gameControls = document.getElementById('gameControls');
    const loginModal = document.getElementById('loginModal');

    // Flag to prevent false positive on initial page load
    let hasInitialized = false;

    // Observer to detect when game.js hides the login/lobby
    const observer = new MutationObserver(() => {
      // Skip the first few mutations that happen during page load
      if (!hasInitialized) {
        return;
      }

      if (lobbyPanel.hidden || lobbyPanel.style.display === 'none') {
        // Game Started (or Login)
        if (!gamePanel.hidden && gamePanel.style.display !== 'none') {
          // Actually Game Started
          lobbyControls.style.display = 'none';
          gameControls.style.display = 'flex';
          loginModal.classList.remove('visible');
        }
      } else {
        // Lobby Mode
        lobbyControls.style.display = 'flex';
        gameControls.style.display = 'none';
        loginModal.classList.remove('visible');
      }
    });

    observer.observe(lobbyPanel, { attributes: true, attributeFilter: ['hidden', 'style', 'class'] });
    observer.observe(gamePanel, { attributes: true, attributeFilter: ['hidden', 'style', 'class'] });

    // Set initialization flag after a short delay to allow page to fully load
    // This prevents the observer from acting on the initial dummy element states
    setTimeout(() => {
      hasInitialized = true;
    }, 100);

  </script>
</body>

</html>